<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Investor Lens • Heat + KPI + Slides</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    --green:#1F6F63; --green-700:#0E3F38; --muted:#6A7D80; --line:#E6EEEC; --bg:#F6FAF9;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#142a2a;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  header{padding:14px 16px;display:flex;gap:10px;align-items:center}
  .badge{background:#E9F6F0;color:var(--green-700);font-weight:800;padding:6px 10px;border-radius:8px}
  h1{font-size:18px;margin:0}
  .wrap{padding:0 16px 16px}
  .row{display:grid;grid-template-columns:1.35fr .9fr;gap:12px}
  @media (max-width:980px){.row{grid-template-columns:1fr}}

  /* ===== Map ===== */
  #map{height:66vh;min-height:420px;background:#fff;border:1px solid var(--line);border-radius:12px;position:relative;overflow:hidden;z-index:10}
  .leaflet-container{cursor:grab;touch-action:pan-x pan-y}
  .leaflet-container:active{cursor:grabbing}
  /* overlay search box */
  .searchCtl{position:absolute;z-index:800;left:10px;top:10px;background:#fff;border:1px solid var(--line);
    border-radius:999px;padding:6px;display:flex;gap:6px;align-items:center;box-shadow:0 6px 14px rgba(0,0,0,.08)}
  .searchCtl input{border:0;outline:none;padding:6px 8px;width:240px;border-radius:999px;font-weight:700;color:var(--green-700)}
  .btn{background:var(--green);color:#fff;border:0;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}

  /* ให้ marker คลิกได้ชัวร์ */
  .leaflet-marker-pane{z-index:650 !important;}
  .leaflet-overlay-pane{z-index:600 !important;}
  .leaflet-heatmap-layer,
  .leaflet-overlay-pane canvas{pointer-events:none;} /* heat/canvas ไม่บังคลิก */
  /* attribution อย่ามาบังคลิก */
  .leaflet-control-attribution{pointer-events:none;opacity:.75}

  /* ป้ายชื่อย่าน (tooltip) */
  .leaflet-tooltip{pointer-events:none;}
  .area-tip{
    background:#fff;border:1px solid #E6EEEC;border-radius:999px;
    padding:4px 8px;font-weight:800;color:#0E3F38;box-shadow:0 2px 8px rgba(0,0,0,.10)
  }
  .area-tip:before{display:none;}

  /* ===== Right Panel ===== */
  .panel{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;min-height:66vh;position:relative;z-index:1}
  .kpis{display:flex;gap:8px;margin:0 0 10px}
  .kpi{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px}
  .kpi small{color:var(--muted)} .kpi b{color:var(--green-700);font-size:20px}

  /* ===== Slides ===== */
  .frame{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
  .track{display:flex;transition:transform .35s ease;will-change:transform}
  .slide{min-width:100%;padding:12px}
  .slide h3{margin:0 0 8px;font-size:16px}
  .facts{margin:6px 0 0 18px;line-height:1.6}
  .dots{display:flex;justify-content:center;gap:10px;margin-top:10px}
  .dot{width:28px;height:8px;border-radius:999px;background:#E0E7E4;border:0;cursor:pointer}
  .dot[aria-selected="true"]{background:var(--green)}

  /* debug status (ซ่อนตอนบูตเสร็จ) */
  .diag{position:fixed;left:8px;top:8px;z-index:2000;background:#fff;border:1px solid #ddd;border-radius:8px;
        padding:6px 8px;font-size:13px;display:flex;gap:8px;align-items:center;box-shadow:0 6px 14px rgba(0,0,0,.08)}
  .pill{padding:2px 8px;border-radius:999px;background:#eee}
  .ok{background:#DFF5E1;color:#0E6B3B}.bad{background:#FFE2E2;color:#A13232}
</style>
</head>
<body>
<header><div class="badge">PD</div><h1>Investor Lens • Heat + KPI + Slides</h1></header>

<div class="diag"><span>STATUS:</span><span id="sLeaflet" class="pill bad">Leaflet ❌</span><span id="sHeat" class="pill bad">Heat ❌</span><span id="sMap" class="pill bad">Map ❌</span></div>

<div class="wrap">
  <div class="row">
    <section><div id="map"></div></section>

    <aside class="panel">
      <div class="kpis">
        <div class="kpi"><small>Yield (ย่าน)</small><b id="kpiYield">—</b></div>
        <div class="kpi"><small>Cap Rate (ย่าน)</small><b id="kpiCap">—</b></div>
      </div>

      <div class="frame">
        <div class="track" id="track">
          <section class="slide">
            <h3>วิธีอ่าน Heat Map</h3>
            <ul class="facts">
              <li>สีเข้ม = ความหนาแน่นกิจกรรมสูง</li>
              <li>สีอ่อน = ความหนาแน่นต่ำ</li>
              <li>ค้นหาย่าน แล้วกด “เลือก” แผนที่จะซูมไปย่านนั้น</li>
            </ul>
          </section>
          <section class="slide">
            <h3>Demand &amp; Liquidity</h3>
            <ul class="facts">
              <li><b>Take-up Rate</b> = % ยูนิตขายได้ช่วงเปิดตัว</li>
              <li><b>Absorption</b> = ยูนิตขายออกต่อรอบเวลา</li>
              <li><b>Overhang</b> = ยูนิตเหลือขาย</li>
            </ul>
          </section>
          <section class="slide">
            <h3>Supply &amp; Rental</h3>
            <ul class="facts">
              <li><b>New Projects</b> = เม็ดเงิน/จำนวนโครงการใหม่</li>
              <li><b>Yield vs Cap Rate</b> = ผลตอบแทนขั้นต้น vs ผลตอบแทนสุทธิ</li>
            </ul>
          </section>
          <section class="slide">
            <h3>Price Metrics (10 ปี)</h3>
            <ul class="facts">
              <li><b>Launch</b> = ราคาเปิดตัว</li>
              <li><b>Resale</b> = ราคามือสอง</li>
              <li><b>Treasury Benchmark</b> = เส้นอ้างอิง risk-free</li>
            </ul>
          </section>
        </div>
      </div>
      <div class="dots" role="tablist">
        <button class="dot" data-go="1" aria-selected="true"></button>
        <button class="dot" data-go="2"></button>
        <button class="dot" data-go="3"></button>
        <button class="dot" data-go="4"></button>
      </div>
    </aside>
  </div>
</div>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
/* ================= DATA ================= */
const INV = {
  sukhumvit:{ center:[13.736,100.576],
    heat:[[13.736,100.576,1.0],[13.740,100.580,0.95],[13.730,100.572,0.9],[13.734,100.585,0.85],[13.741,100.569,0.8],[13.728,100.579,0.8],[13.738,100.573,0.75],[13.732,100.570,0.75]],
    kpi:{yield:5.6,cap:4.2}},
  ekkamai:{ center:[13.727,100.587],
    heat:[[13.727,100.587,0.95],[13.731,100.590,0.8],[13.724,100.584,0.7]],
    kpi:{yield:5.2,cap:3.9}},
  thonglor:{ center:[13.731,100.582],
    heat:[[13.731,100.582,0.9],[13.734,100.584,0.8],[13.728,100.580,0.7]],
    kpi:{yield:5.4,cap:4.0}},
  rama9:{ center:[13.757,100.565],
    heat:[[13.757,100.565,0.95],[13.760,100.568,0.8],[13.754,100.562,0.75]],
    kpi:{yield:5.0,cap:3.7}}
};
const LABEL={sukhumvit:'Sukhumvit',ekkamai:'Ekkamai',thonglor:'Thonglor',rama9:'Rama 9'};
let active='sukhumvit', map, heatLayer;

/* ============== UI HELPERS ============== */
function setKPI(){
  const a = INV[active]||INV.sukhumvit;
  document.getElementById('kpiYield').textContent=a.kpi.yield+'%';
  document.getElementById('kpiCap').textContent=a.kpi.cap+'%';
}
function ensureSearchCtl(){
  if (document.querySelector('.searchCtl')) return;
  const ctl=document.createElement('div'); ctl.className='searchCtl';
  ctl.innerHTML=`<input id="area" placeholder="Sukhumvit / Ekkamai / Thonglor / Rama 9">
                 <button class="btn" id="go">เลือก</button>`;
  document.getElementById('map').appendChild(ctl);
  const input=ctl.querySelector('#area'), go=ctl.querySelector('#go');
  const apply=()=>{
    const v=(input.value||'Sukhumvit').trim().toLowerCase();
    active = v.startsWith('ekk')?'ekkamai'
          : v.startsWith('tho')?'thonglor'
          : v.includes('rama')||v.includes('พระราม')?'rama9'
          : 'sukhumvit';
    selectArea(active);
  };
  go.addEventListener('click',apply);
  input.addEventListener('keydown',e=>{if(e.key==='Enter')apply();});
  L.DomEvent.disableClickPropagation(ctl);
  L.DomEvent.disableScrollPropagation(ctl);
}

/* ============== AREA SELECT ============== */
function selectArea(key){
  if(!INV[key]) return;
  active=key;
  const a=INV[active];
  map.setView(a.center,14);
  heatLayer.setLatLngs(a.heat);
  setKPI();
}
function nearestArea(latlng){
  let best=null,dist=Infinity;
  for(const [k,v] of Object.entries(INV)){
    const d=map.distance(latlng, L.latLng(v.center));
    if(d<dist){dist=d;best=k;}
  }
  return {key:best,dist};
}

/* ✅ ป้ายย่านกดได้: marker โปร่งใส (hit-box ใหญ่) + tooltip ถาวร */
function addAreaMarkers(){
  for(const [k,v] of Object.entries(INV)){
    const icon = L.divIcon({
      className: 'area-hit',
      html: '',
      iconSize: [160, 46],      // hit-box กว้าง คลิกง่าย
      iconAnchor: [80, 23]
    });
    const m = L.marker(v.center,{icon,interactive:true,keyboard:true,zIndexOffset:900}).addTo(map);
    m.bindTooltip(LABEL[k] || k, {
      permanent: true,
      direction: 'center',
      className: 'area-tip',
      opacity: 1,
      interactive: true
    });
    m.on('click', ()=> selectArea(k));
    m.on('add', ()=>{
      const tip=m.getTooltip(); if(!tip) return;
      const el=tip.getElement(); if(!el) return;
      el.style.pointerEvents='auto'; el.style.cursor='pointer';
      el.addEventListener('click', ()=> selectArea(k));
    });
  }
}

/* ============== MAP INIT ============== */
function initMap(){
  const sLeaf=document.getElementById('sLeaflet');
  const sHeat=document.getElementById('sHeat');
  const sMap=document.getElementById('sMap');
  if(window.L && typeof L.map==='function') sLeaf.className='pill ok';
  if(window.L && L.heatLayer) sHeat.className='pill ok';

  const el=document.getElementById('map');
  if(el._leaflet_id){ const p=el.parentNode,n=el.cloneNode(false); n.id='map'; p.replaceChild(n,el); }

  map=L.map('map',{zoomControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

  map.dragging.enable(); map.scrollWheelZoom.enable(); map.touchZoom.enable();
  map.doubleClickZoom.enable(); map.boxZoom.enable(); map.keyboard.enable();

  map.setView(INV[active].center,14);

  heatLayer=L.heatLayer(INV[active].heat,{radius:42,blur:20,maxZoom:19,opacity:1,
    gradient:{0.3:'#4FC3F7',0.6:'#FFF176',0.8:'#FFA726',1.0:'#E53935'}}).addTo(map);

  // attribution ไปมุมซ้ายล่าง จะได้ไม่ทับป้าย
  map.attributionControl.setPosition('bottomleft');

  sMap.className='pill ok';

  addAreaMarkers();

  // คลิกแผนที่ให้เด้งไปย่านที่ใกล้สุด (ภายใน 5 กม.)
  map.on('click',e=>{
    const {key,dist}=nearestArea(e.latlng);
    if(key && dist<5000) selectArea(key);
  });

  ensureSearchCtl();
  setKPI();
}

/* ============== SLIDES ============== */
function initSlides(){
  const track=document.getElementById('track');
  const dots=[...document.querySelectorAll('.dot')];
  let cur=1;
  const show=n=>{
    cur=Math.max(1,Math.min(4,n));
    track.style.transform=`translateX(${-(cur-1)*100}%)`;
    dots.forEach(d=>d.setAttribute('aria-selected', d.dataset.go==cur?'true':'false'));
  };
  const frame=track.parentElement; let sx=0,sy=0,dx=0,dy=0,drag=false;
  frame.addEventListener('pointerdown',e=>{drag=true;sx=e.clientX;sy=e.clientY;frame.setPointerCapture(e.pointerId);});
  frame.addEventListener('pointermove',e=>{if(!drag)return;dx=e.clientX-sx;dy=e.clientY-sy;});
  frame.addEventListener('pointerup',()=>{if(!drag)return;drag=false;if(Math.abs(dx)>80&&Math.abs(dx)>Math.abs(dy))show(cur+(dx>0?-1:1));dx=dy=0;});
  dots.forEach(d=>d.addEventListener('click',()=>show(+d.dataset.go)));
  show(1);
}

/* ============== BOOT ============== */
window.addEventListener('load', ()=>{
  // ซ่อนกล่องสถานะ
  document.querySelector('.diag').style.display='none';
  initSlides();
  initMap();

  // รองรับ ?area=sukhumvit / ekkamai / thonglor / rama9
  const p=new URLSearchParams(location.search); const area=p.get('area');
  if(area){ const i=document.getElementById('area'); if(i){ i.value=area; setTimeout(()=>document.getElementById('go')?.click(),400); } }
});
</script>
</body>
</html>
